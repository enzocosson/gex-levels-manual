//@version=6
indicator("GEX Professional Levels - Auto", overlay=true, max_lines_count=500, max_labels_count=500)


// ==================== CSV DATA (AUTO-GENERATED) ====================
string es_csv_zero = "strike,importance,type,label,dte,description,call_res_all,put_sup_all\n6925.26,10,gamma_flip,Zero Gamma,0DTE,Negative Gamma,2310164.380000001,176656.84\n6925.0,10,gamma_wall_put,Gamma Wall (Put),0DTE,69249 GEX,2310164.380000001,176656.84\n6930.0,10,gamma_wall_call,Gamma Wall (Call),0DTE,2056788 GEX,2310164.380000001,176656.84\n6935.0,9,hvl,HVL #2,0DTE,158857 GEX @ 0.1% from spot,2310164.380000001,176656.84\n6920.0,9,put_sup_0dte,PutSup0DTE #2,0DTE,Support 0DTE: 69061 GEX,2310164.380000001,176656.84\n6923.8,9,call_wall_api,Call Wall (Vol API),0DTE,Major from API,2310164.380000001,176656.84\n6945.0,8,call_wall,Call Wall #4,0DTE,14532 GEX,2310164.380000001,176656.84\n6910.0,8,put_wall,Put Wall #4,0DTE,8398 GEX,2310164.380000001,176656.84\n6915.0,8,put_wall,Put Wall #3,0DTE,17931 GEX,2310164.380000001,176656.84\n6940.0,8,call_wall,Call Wall #3,0DTE,49048 GEX,2310164.380000001,176656.84\n6919.92,8,call_wall_api,Call Wall (OI API),0DTE,Major from API,2310164.380000001,176656.84\n7105.0,8,max_pain,Max Pain,0DTE,Expiration Target,2310164.380000001,176656.84\n6950.0,7,strike_call,Call Resist,0DTE,12154 GEX,2310164.380000001,176656.84\n6955.0,7,strike_call,Call Resist,0DTE,7671 GEX,2310164.380000001,176656.84\n6960.0,7,strike_call,Call Resist,0DTE,5304 GEX,2310164.380000001,176656.84\n6905.0,7,strike_put,Put Support,0DTE,5259 GEX,2310164.380000001,176656.84\n6965.0,7,strike_call,Call Resist,0DTE,1633 GEX,2310164.380000001,176656.84\n6900.0,7,strike_put,Put Support,0DTE,1439 GEX,2310164.380000001,176656.84\n6970.0,7,strike_call,Call Resist,0DTE,1393 GEX,2310164.380000001,176656.84\n"
string es_csv_one = "strike,importance,type,label,dte,description,call_res_all,put_sup_all\n6928.39,10,gamma_flip,Zero Gamma,0DTE,Negative Gamma,35530.51999999999,14007.109999999999\n6900.0,10,gamma_wall_put,Gamma Wall (Put),0DTE,2546 GEX,35530.51999999999,14007.109999999999\n6950.0,10,gamma_wall_call,Gamma Wall (Call),0DTE,7470 GEX,35530.51999999999,14007.109999999999\n6955.0,9,hvl,HVL #2,0DTE,5038 GEX @ 0.4% from spot,35530.51999999999,14007.109999999999\n6940.0,9,hvl,HVL #3,0DTE,3632 GEX @ 0.1% from spot,35530.51999999999,14007.109999999999\n6920.0,9,put_sup_0dte,PutSup0DTE #2,0DTE,Support 0DTE: 1618 GEX,35530.51999999999,14007.109999999999\n6945.0,8,call_wall,Call Wall #4,0DTE,3558 GEX,35530.51999999999,14007.109999999999\n6895.0,8,put_wall,Put Wall #4,0DTE,1164 GEX,35530.51999999999,14007.109999999999\n6910.0,8,put_wall,Put Wall #3,0DTE,1262 GEX,35530.51999999999,14007.109999999999\n6930.0,8,put_wall_api,Put Wall (OI API),0DTE,Major from API,35530.51999999999,14007.109999999999\n6880.0,8,call_wall_api,Call Wall (OI API),0DTE,Major from API,35530.51999999999,14007.109999999999\n7140.0,8,max_pain,Max Pain,0DTE,Expiration Target,35530.51999999999,14007.109999999999\n6960.0,7,strike_call,Call Resist,0DTE,3431 GEX,35530.51999999999,14007.109999999999\n6970.0,7,strike_call,Call Resist,0DTE,2426 GEX,35530.51999999999,14007.109999999999\n6965.0,7,strike_call,Call Resist,0DTE,2002 GEX,35530.51999999999,14007.109999999999\n6935.0,7,strike_call,Call Resist,0DTE,1957 GEX,35530.51999999999,14007.109999999999\n6975.0,7,strike_call,Call Resist,0DTE,1441 GEX,35530.51999999999,14007.109999999999\n6885.0,7,strike_put,Put Support,0DTE,972 GEX,35530.51999999999,14007.109999999999\n"
string es_csv_full = "strike,importance,type,label,dte,description,call_res_all,put_sup_all\n6925.26,10,gamma_flip,Zero Gamma,0DTE,Negative Gamma,2442940.1799999992,199045.23000000004\n6920.0,10,gamma_wall_put,Gamma Wall (Put),0DTE,68466 GEX,2442940.1799999992,199045.23000000004\n6930.0,10,gamma_wall_call,Gamma Wall (Call),0DTE,2060619 GEX,2442940.1799999992,199045.23000000004\n6935.0,9,hvl,HVL #2,0DTE,162158 GEX @ 0.1% from spot,2442940.1799999992,199045.23000000004\n6925.0,9,put_sup_0dte,PutSup0DTE #2,0DTE,Support 0DTE: 64259 GEX,2442940.1799999992,199045.23000000004\n6923.8,9,call_wall_api,Call Wall (Vol API),0DTE,Major from API,2442940.1799999992,199045.23000000004\n6950.0,8,call_wall,Call Wall #4,0DTE,31706 GEX,2442940.1799999992,199045.23000000004\n6910.0,8,put_wall,Put Wall #4,0DTE,9055 GEX,2442940.1799999992,199045.23000000004\n6915.0,8,put_wall,Put Wall #3,0DTE,16819 GEX,2442940.1799999992,199045.23000000004\n6940.0,8,call_wall,Call Wall #3,0DTE,55304 GEX,2442940.1799999992,199045.23000000004\n6700.0,8,call_wall_api,Call Wall (OI API),0DTE,Major from API,2442940.1799999992,199045.23000000004\n7145.0,8,max_pain,Max Pain,0DTE,Expiration Target,2442940.1799999992,199045.23000000004\n7000.0,7,strike_call,Call Resist,0DTE,20860 GEX,2442940.1799999992,199045.23000000004\n6945.0,7,strike_call,Call Resist,0DTE,20662 GEX,2442940.1799999992,199045.23000000004\n6955.0,7,strike_call,Call Resist,0DTE,17251 GEX,2442940.1799999992,199045.23000000004\n6960.0,7,strike_call,Call Resist,0DTE,13729 GEX,2442940.1799999992,199045.23000000004\n6975.0,7,strike_call,Call Resist,0DTE,8604 GEX,2442940.1799999992,199045.23000000004\n6970.0,7,strike_call,Call Resist,0DTE,8508 GEX,2442940.1799999992,199045.23000000004\n6980.0,7,strike_call,Call Resist,0DTE,6255 GEX,2442940.1799999992,199045.23000000004\n"
string nq_csv_zero = "strike,importance,type,label,dte,description,call_res_all,put_sup_all\n25641.66,10,gamma_flip,Zero Gamma,0DTE,Negative Gamma,47933.90000000001,21948.32\n25640.0,10,gamma_wall_put,Gamma Wall (Put),0DTE,6916 GEX,47933.90000000001,21948.32\n25650.0,10,gamma_wall_call,Gamma Wall (Call),0DTE,42747 GEX,47933.90000000001,21948.32\n25630.0,9,hvl,HVL #3,0DTE,5403 GEX @ 0.1% from spot,47933.90000000001,21948.32\n25700.0,9,call_res_0dte,CallRes0DTE #2,0DTE,Resistance 0DTE: 1489 GEX,47933.90000000001,21948.32\n25639.48,9,call_wall_api,Call Wall (Vol API),0DTE,Major from API,47933.90000000001,21948.32\n25730.0,8,call_wall,Call Wall #4,0DTE,475 GEX,47933.90000000001,21948.32\n25660.0,8,put_wall,Put Wall #4,0DTE,2445 GEX,47933.90000000001,21948.32\n25620.0,8,put_wall,Put Wall #3,0DTE,2639 GEX,47933.90000000001,21948.32\n25720.0,8,call_wall,Call Wall #3,0DTE,555 GEX,47933.90000000001,21948.32\n25670.0,8,call_wall_api,Call Wall (OI API),0DTE,Major from API,47933.90000000001,21948.32\n26160.0,8,max_pain,Max Pain,0DTE,Expiration Target,47933.90000000001,21948.32\n25625.0,7,strike_put,Put Support,0DTE,2193 GEX,47933.90000000001,21948.32\n25675.0,7,strike_put,Put Support,0DTE,1181 GEX,47933.90000000001,21948.32\n25610.0,7,strike_put,Put Support,0DTE,1157 GEX,47933.90000000001,21948.32\n25590.0,7,strike_put,Put Support,0DTE,844 GEX,47933.90000000001,21948.32\n25580.0,7,strike_put,Put Support,0DTE,706 GEX,47933.90000000001,21948.32\n25570.0,7,strike_put,Put Support,0DTE,351 GEX,47933.90000000001,21948.32\n"
string nq_csv_one = "strike,importance,type,label,dte,description,call_res_all,put_sup_all\n25556.78,10,gamma_flip,Zero Gamma,0DTE,Negative Gamma,1918.159999999999,907.0500000000001\n25700.0,10,gamma_wall_call,Gamma Wall (Call),0DTE,309 GEX,1918.159999999999,907.0500000000001\n25500.0,10,gamma_wall_put,Gamma Wall (Put),0DTE,99 GEX,1918.159999999999,907.0500000000001\n25580.0,9,put_sup_0dte,PutSup0DTE #2,0DTE,Support 0DTE: 65 GEX,1918.159999999999,907.0500000000001\n25710.0,9,call_res_0dte,CallRes0DTE #2,0DTE,Resistance 0DTE: 254 GEX,1918.159999999999,907.0500000000001\n25560.0,8,call_wall_api,Call Wall (OI API),0DTE,Major from API,1918.159999999999,907.0500000000001\n25750.0,8,call_wall,Call Wall #3,0DTE,189 GEX,1918.159999999999,907.0500000000001\n25730.0,8,call_wall,Call Wall #4,0DTE,134 GEX,1918.159999999999,907.0500000000001\n25510.0,8,put_wall,Put Wall #3,0DTE,60 GEX,1918.159999999999,907.0500000000001\n25480.0,8,put_wall,Put Wall #4,0DTE,59 GEX,1918.159999999999,907.0500000000001\n26130.0,8,max_pain,Max Pain,0DTE,Expiration Target,1918.159999999999,907.0500000000001\n25680.0,7,strike_call,Call Resist,0DTE,117 GEX,1918.159999999999,907.0500000000001\n25660.0,7,strike_call,Call Resist,0DTE,102 GEX,1918.159999999999,907.0500000000001\n"
string nq_csv_full = "strike,importance,type,label,dte,description,call_res_all,put_sup_all\n25641.66,10,gamma_flip,Zero Gamma,0DTE,Negative Gamma,51494.87999999999,22741.92\n25640.0,10,gamma_wall_put,Gamma Wall (Put),0DTE,6888 GEX,51494.87999999999,22741.92\n25650.0,10,gamma_wall_call,Gamma Wall (Call),0DTE,42859 GEX,51494.87999999999,22741.92\n25630.0,9,hvl,HVL #3,0DTE,5399 GEX @ 0.1% from spot,51494.87999999999,22741.92\n25700.0,9,call_res_0dte,CallRes0DTE #2,0DTE,Resistance 0DTE: 1948 GEX,51494.87999999999,22741.92\n25639.48,9,call_wall_api,Call Wall (Vol API),0DTE,Major from API,51494.87999999999,22741.92\n25720.0,8,call_wall,Call Wall #4,0DTE,636 GEX,51494.87999999999,22741.92\n25660.0,8,put_wall,Put Wall #4,0DTE,2338 GEX,51494.87999999999,22741.92\n25620.0,8,put_wall,Put Wall #3,0DTE,2662 GEX,51494.87999999999,22741.92\n25250.0,8,call_wall,Call Wall #3,0DTE,972 GEX,51494.87999999999,22741.92\n25670.0,8,call_wall_api,Call Wall (OI API),0DTE,Major from API,51494.87999999999,22741.92\n26110.0,8,max_pain,Max Pain,0DTE,Expiration Target,51494.87999999999,22741.92\n25625.0,7,strike_put,Put Support,0DTE,2150 GEX,51494.87999999999,22741.92\n25610.0,7,strike_put,Put Support,0DTE,1200 GEX,51494.87999999999,22741.92\n25675.0,7,strike_put,Put Support,0DTE,1108 GEX,51494.87999999999,22741.92\n25590.0,7,strike_put,Put Support,0DTE,887 GEX,51494.87999999999,22741.92\n25580.0,7,strike_put,Put Support,0DTE,776 GEX,51494.87999999999,22741.92\n25730.0,7,strike_call,Call Resist,0DTE,616 GEX,51494.87999999999,22741.92\n"


// ==================== AUTO-DETECTION TICKER ====================
string detected_ticker = "ES"
if str.contains(syminfo.ticker, "NQ") or str.contains(syminfo.ticker, "NDX") or str.contains(syminfo.ticker, "NAS")
    detected_ticker := "NQ"
else if str.contains(syminfo.ticker, "ES") or str.contains(syminfo.ticker, "SPX") or str.contains(syminfo.ticker, "SP500")
    detected_ticker := "ES"


// ==================== MULTIPLICATEURS FIXES POUR CONVERSION ====================
float SPX_MULTIPLIER = 1.00685
float NDX_MULTIPLIER = 1.00842

float conversion_multiplier = 1.0
bool needs_conversion = false

if detected_ticker == "ES"
    if str.contains(syminfo.ticker, "ES") and not str.contains(syminfo.ticker, "SPX")
        conversion_multiplier := SPX_MULTIPLIER
        needs_conversion := true
else if detected_ticker == "NQ"
    if str.contains(syminfo.ticker, "NQ") and not str.contains(syminfo.ticker, "NDX")
        conversion_multiplier := NDX_MULTIPLIER
        needs_conversion := true


// ==================== PARAM√àTRES ====================
string selected_dte = input.string("0DTE", "üìÖ DTE Period", options=["0DTE", "1DTE", "FULL"], group="üéØ Settings", tooltip="Days To Expiration")


// ==================== FILTRES PAR IMPORTANCE ====================
bool show_imp_10 = input.bool(true, "Importance 10 (Gamma Flip/Walls)", group="üéØ Importance Filters")
bool show_imp_9 = input.bool(true, "Importance 9 (HVL, 0DTE Levels)", group="üéØ Importance Filters")
bool show_imp_8 = input.bool(true, "Importance 8 (Secondary Walls, Max Pain)", group="üéØ Importance Filters")
bool show_imp_7 = input.bool(false, "Importance 7 (Strikes, Vol Triggers)", group="üéØ Importance Filters")


// ==================== FILTRES PAR TYPE ====================
bool show_gamma_flip = input.bool(true, "Zero Gamma", group="üìå Level Types")
bool show_gamma_walls = input.bool(true, "Gamma Walls", group="üìå Level Types")
bool show_hvl = input.bool(true, "HVL (High Vol Levels)", group="üìå Level Types")
bool show_0dte_levels = input.bool(true, "0DTE Specific Levels", group="üìå Level Types")
bool show_max_pain = input.bool(true, "Max Pain", group="üìå Level Types")
bool show_strikes = input.bool(false, "Top Strikes", group="üìå Level Types")
bool show_vol_triggers = input.bool(false, "Vol Triggers", group="üìå Level Types")


// ==================== STYLE ====================
color color_gamma_flip = input.color(color.new(color.purple, 0), "Zero Gamma", group="üé® Colors", inline="c1")
color color_call_wall = input.color(color.new(color.red, 0), "Call Wall", group="üé® Colors", inline="c2")
color color_put_wall = input.color(color.new(color.green, 0), "Put Wall", group="üé® Colors", inline="c2")
color color_hvl = input.color(color.new(color.orange, 0), "HVL", group="üé® Colors", inline="c3")
color color_0dte = input.color(color.new(color.yellow, 0), "0DTE Levels", group="üé® Colors", inline="c4")
color color_max_pain = input.color(color.new(color.blue, 0), "Max Pain", group="üé® Colors", inline="c5")
color color_strikes = input.color(color.new(color.gray, 30), "Strikes", group="üé® Colors", inline="c6")


bool show_labels = input.bool(true, "Show Labels", group="üè∑Ô∏è Labels")
string label_size = input.string("Small", "Label Size", options=["Tiny", "Small", "Normal", "Large"], group="üè∑Ô∏è Labels")
bool use_distance_filter = input.bool(false, "Filter Labels Near Price", group="üè∑Ô∏è Labels")
float label_min_distance_pct = input.float(0.3, "Min Distance from Price (%)", minval=0, maxval=5, step=0.1, group="üè∑Ô∏è Labels")


// ==================== STOCKAGE ====================
var array<line> all_lines = array.new<line>()
var array<label> all_labels = array.new<label>()


// ==================== FONCTIONS ====================
get_label_size(string size) =>
    size == "Tiny" ? size.tiny : size == "Small" ? size.small : size == "Normal" ? size.normal : size.large


should_show_level(int importance, string level_type) =>
    bool show_importance = (importance == 10 and show_imp_10) or (importance == 9 and show_imp_9) or (importance == 8 and show_imp_8) or (importance == 7 and show_imp_7)
    bool show_type = (str.contains(level_type, "gamma_flip") and show_gamma_flip) or (str.contains(level_type, "gamma_wall") and show_gamma_walls) or (str.contains(level_type, "hvl") and show_hvl) or (str.contains(level_type, "0dte") and show_0dte_levels) or (str.contains(level_type, "max_pain") and show_max_pain) or (str.contains(level_type, "strike_") and show_strikes) or (str.contains(level_type, "vol_trigger") and show_vol_triggers) or str.contains(level_type, "call_wall") or str.contains(level_type, "put_wall")
    show_importance and show_type


get_level_color(string level_type) =>
    str.contains(level_type, "gamma_flip") ? color_gamma_flip : str.contains(level_type, "gamma_wall_call") or str.contains(level_type, "call_wall") or str.contains(level_type, "call_res") ? color_call_wall : str.contains(level_type, "gamma_wall_put") or str.contains(level_type, "put_wall") or str.contains(level_type, "put_sup") ? color_put_wall : str.contains(level_type, "hvl") ? color_hvl : str.contains(level_type, "0dte") ? color_0dte : str.contains(level_type, "max_pain") ? color_max_pain : color_strikes


clear_all_objects() =>
    if array.size(all_lines) > 0
        for i = 0 to array.size(all_lines) - 1
            line.delete(array.get(all_lines, i))
        array.clear(all_lines)
    if array.size(all_labels) > 0
        for i = 0 to array.size(all_labels) - 1
            label.delete(array.get(all_labels, i))
        array.clear(all_labels)


process_csv(string csv_data) =>
    if bar_index == last_bar_index
        lines_array = str.split(csv_data, "\n")
        int total_lines = array.size(lines_array)
        for i = 1 to total_lines - 1
            if i < total_lines
                string line_str = array.get(lines_array, i)
                line_str := str.replace_all(line_str, "\r", "")
                if str.length(line_str) > 10 and not str.contains(line_str, "strike,importance")
                    fields = str.split(line_str, ",")
                    int num_fields = array.size(fields)
                    if num_fields >= 6
                        string field0 = array.get(fields, 0)
                        string field1 = array.get(fields, 1)
                        if str.length(field0) > 0 and str.length(field1) > 0
                            float strike_price_raw = str.tonumber(field0)
                            int importance = int(str.tonumber(field1))
                            if not na(strike_price_raw) and not na(importance) and importance >= 7 and importance <= 10
                                // CONVERSION AVEC MULTIPLICATEUR FIXE
                                float strike_price = needs_conversion ? strike_price_raw * conversion_multiplier : strike_price_raw
                                
                                string level_type = array.get(fields, 2)
                                string label_text = array.get(fields, 3)
                                if should_show_level(importance, level_type)
                                    color level_color = get_level_color(level_type)
                                    line new_line = line.new(x1=bar_index[500], y1=strike_price, x2=bar_index, y2=strike_price, color=level_color, width=1, style=line.style_solid, extend=extend.right)
                                    array.push(all_lines, new_line)
                                    if show_labels
                                        bool show_this_label = true
                                        if use_distance_filter
                                            float price_distance = math.abs(close - strike_price)
                                            float min_distance = close * (label_min_distance_pct / 100)
                                            show_this_label := price_distance > min_distance
                                        if show_this_label
                                            string simple_label = label_text + " " + str.tostring(strike_price, "#.##")
                                            label new_label = label.new(x=bar_index, y=strike_price, text=simple_label, color=color.new(color.white, 100), textcolor=level_color, style=label.style_none, size=get_label_size(label_size))
                                            array.push(all_labels, new_label)


// ==================== EX√âCUTION ====================
if barstate.islast
    clear_all_objects()
    
    string csv_active = ""
    
    if detected_ticker == "ES"
        csv_active := selected_dte == "0DTE" ? es_csv_zero : selected_dte == "1DTE" ? es_csv_one : es_csv_full
    else
        csv_active := selected_dte == "0DTE" ? nq_csv_zero : selected_dte == "1DTE" ? nq_csv_one : nq_csv_full
    
    process_csv(csv_active)


plot(close, title="Price", display=display.none)
